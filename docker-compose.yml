services:
  # ─── Backend API (Gunicorn + Uvicorn Workers) ─────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sentinel-backend
    ports:
      - "8000:8000"
    environment:
      # ── Core ──────────────────────────────────────────────────────────────
      - APP_ENV=${APP_ENV:-production}
      - PORT=8000
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DATA_SOURCE=${DATA_SOURCE:-auto}

      # ── CORS ──────────────────────────────────────────────────────────────
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}

      # ── Auth (set FIREBASE_PROJECT_ID to enable JWT verification) ─────────
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-}

      # ── Rate limiting ──────────────────────────────────────────────────────
      - RATE_LIMIT_PER_MIN=${RATE_LIMIT_PER_MIN:-60}

      # ── Gunicorn workers ──────────────────────────────────────────────────
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-4}

      # ── Error monitoring ──────────────────────────────────────────────────
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_TRACES_RATE=${SENTRY_TRACES_RATE:-0.1}

    volumes:
      # Persist settings across container restarts
      - sentinel_data:/app/data
      # ML models (read-only — place .keras files here)
      - ./backend/ml:/app/ml:ro

    # Required for smartctl to access real disk devices
    privileged: true
    restart: unless-stopped

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ─── Frontend (React + Nginx) ─────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Must be publicly reachable from the user's browser
        - VITE_API_URL=${VITE_API_URL:-http://localhost:8000/api/v1}
    container_name: sentinel-frontend
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

# ─── Volumes ─────────────────────────────────────────────────────────────────
volumes:
  sentinel_data:
    driver: local

# ─── Networks ────────────────────────────────────────────────────────────────
networks:
  default:
    name: sentinel-network
